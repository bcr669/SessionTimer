<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Match theme color to app background for seamless title bar -->
    <meta name="theme-color" content="#1a1a1a">
    <title>Session Timer</title>
    
    <!-- Updated Manifest with Window Controls Overlay support -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNlc3Npb24gVGltZXIiLAogICJzaG9ydF9uYW1lIjogIlNlc3Npb24iLAogICJzdGFydF91cmwiOiAiLi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJkaXNwbGF5X292ZXJyaWRlIjogWyJ3aW5kb3ctY29udHJvbHMtb3ZlcmxheSIsICJzdGFuZGFsb25lIl0sCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMWExYTFhIiwKICAidGhlbWVfY29sb3IiOiAiIzFhMWExYSIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzI1MDQvMjUwNDg5Ni5wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICBdCn0=">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #1a1a1a; margin: 0; overflow: hidden; height: 100vh; width: 100vw; }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
        .animate-flash { animation: flash 1s steps(1) infinite; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        
        /* Draggable area for the title bar if overlay is active */
        .titlebar-drag {
            -webkit-app-region: drag;
            app-region: drag;
        }
        button {
            -webkit-app-region: no-drag;
            app-region: no-drag;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = "self.addEventListener('fetch', function(event) {});";
                const blob = new Blob([swCode], {type: 'text/javascript'});
                const url = URL.createObjectURL(blob);
                navigator.serviceWorker.register(url).catch(err => {});
            });
        }

        const { useState, useEffect, useRef } = React;

        const Icons = {
            Play: ({ size = 16, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            ),
            Pause: ({ size = 16, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
            ),
            RotateCw: ({ size = 16, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><polyline points="21 3 21 8 16 8"></polyline></svg>
            ),
            Timer: ({ size = 16, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="10" y1="2" x2="14" y2="2"></line><line x1="12" y1="14" x2="15" y2="11"></line><circle cx="12" cy="14" r="8"></circle></svg>
            ),
            Settings: ({ size = 16, className = "" }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            )
        };

        const App = () => {
            const INITIAL_SECONDS = 53 * 60;
            const [timeLeft, setTimeLeft] = useState(INITIAL_SECONDS);
            const [isActive, setIsActive] = useState(false);
            const [isFinished, setIsFinished] = useState(false);
            
            const startTimeRef = useRef(null);
            const accumulatedTimeRef = useRef(0);
            const requestRef = useRef(null);

            const formatTime = (s, mode = 'down') => {
                const val = mode === 'down' ? Math.ceil(s) : Math.floor(s);
                const mins = Math.floor(Math.max(0, val) / 60);
                const secs = Math.max(0, val % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            const calculateCurrentTime = () => {
                if (!startTimeRef.current) return INITIAL_SECONDS - accumulatedTimeRef.current;
                return Math.max(0, INITIAL_SECONDS - (accumulatedTimeRef.current + (performance.now() - startTimeRef.current) / 1000));
            };

            const update = () => {
                const newTime = calculateCurrentTime();
                if (newTime <= 0) {
                    setTimeLeft(0); setIsActive(false); setIsFinished(true);
                } else {
                    setTimeLeft(newTime);
                    requestRef.current = requestAnimationFrame(update);
                }
            };

            useEffect(() => {
                if (isActive) {
                    requestRef.current = requestAnimationFrame(update);
                } else {
                    cancelAnimationFrame(requestRef.current);
                }
                return () => cancelAnimationFrame(requestRef.current);
            }, [isActive]);

            const countUpTime = INITIAL_SECONDS - timeLeft;
            const remainingPercent = (timeLeft / INITIAL_SECONDS) * 100;
            const elapsedPercentInv = 100 - (countUpTime / INITIAL_SECONDS * 100);

            const getElapsedColor = (s) => {
                const mins = s / 60;
                if (mins >= 53) return 'text-green-400';
                if (mins >= 38) return 'text-yellow-400';
                if (mins >= 16) return 'text-orange-400';
                return 'text-red-500';
            };

            const getRemainingColor = (s) => {
                const mins = s / 60;
                if (s <= 0) return 'text-green-400';
                if (mins <= 15) return 'text-yellow-400';
                if (mins <= 37) return 'text-orange-400';
                return 'text-red-500';
            };

            const getPayment = (s) => {
                const mins = s / 60;
                if (s <= 0) return { amount: 90, color: 'text-green-400' };
                if (mins <= 15) return { amount: 65, color: 'text-yellow-400' };
                if (mins <= 37) return { amount: 45, color: 'text-orange-400' };
                return { amount: 0, color: 'text-red-500' };
            };

            const getNextLevel = (elapsed) => {
                let target = 0, window = 0;
                if (elapsed < 16*60) { target = 16*60; window = 16*60; }
                else if (elapsed < 38*60) { target = 38*60; window = 22*60; }
                else if (elapsed < 53*60) { target = 53*60; window = 15*60; }
                const rem = Math.max(0, target - elapsed);
                return { remaining: rem, percent: window > 0 ? (rem / window) * 100 : 0 };
            };

            const pay = getPayment(timeLeft);
            const nextLvl = getNextLevel(countUpTime);
            
            const isApproachingThreshold = (t) => {
                if (!isActive) return false;
                const thresholds = [37*60, 15*60, 0];
                return thresholds.some(tr => (t - tr) > 0 && (t - tr) <= 5);
            };
            const shouldFlash = isApproachingThreshold(timeLeft);

            const Ruler = ({ percent, color, rev = false }) => (
                <div className="relative w-full h-[8px] flex items-end">
                    <div className="absolute bottom-0 left-0 right-0 h-[3px] bg-white/5 rounded-full" />
                    <div className="absolute bottom-0 h-[3px] opacity-70 transition-all rounded-full" style={{ width: `${percent}%`, backgroundColor: color, [rev ? 'right' : 'left']: 0 }} />
                    {[0, 25, 50, 75, 100].map(m => (
                        <div key={m} className="absolute w-[1.5px] bg-white h-[6px] bottom-0" style={{ left: `${m}%` }} />
                    ))}
                </div>
            );

            const panel = "relative flex-1 bg-white/5 rounded-lg flex flex-col items-center justify-between pt-2 pb-1.5 px-2 border border-white/5 overflow-hidden";

            return (
                <div className="min-h-screen bg-[#1a1a1a] flex items-center justify-center p-2 text-white font-sans select-none">
                    <div className="w-full max-w-[270px] bg-[#2b2b2b] border border-white/10 shadow-2xl rounded-xl overflow-hidden">
                        {/* Added titlebar-drag class to make the header draggable when wrapper is hidden */}
                        <div className="titlebar-drag flex justify-between items-center px-2 py-1 bg-black/20 border-b border-white/5">
                            <div className="flex items-center gap-1.5">
                                <Icons.Timer size={12} className="text-blue-400" />
                                <span className="text-[10px] font-bold opacity-70 uppercase tracking-tight">Session Timer</span>
                            </div>
                            <Icons.Settings size={11} className="opacity-30" />
                        </div>
                        <div className="p-2 flex gap-1.5">
                            <div className="flex flex-col gap-1.5 flex-1">
                                <div className="flex gap-1.5 h-[84px]">
                                    <div className={panel}>
                                        <span className="text-[14px] opacity-80 font-semibold text-white">Remaining</span>
                                        <div className={`text-xl font-bold tabular-nums ${getRemainingColor(timeLeft)} ${isFinished || shouldFlash ? 'animate-flash' : ''}`}>
                                            {formatTime(timeLeft)}
                                        </div>
                                        <Ruler percent={remainingPercent} color="#4ca67c" />
                                    </div>
                                    <div className={panel}>
                                        <span className="text-[14px] opacity-80 font-semibold text-white">Elapsed</span>
                                        <div className={`text-xl font-bold tabular-nums ${getElapsedColor(countUpTime)}`}>
                                            {formatTime(countUpTime, 'up')}
                                        </div>
                                        <Ruler percent={elapsedPercentInv} color="#b35a5a" rev />
                                    </div>
                                </div>
                                <div className="flex gap-1.5 h-[84px]">
                                    <div className={panel}>
                                        <span className="text-[14px] opacity-80 font-semibold text-white">Pay</span>
                                        <div className={`text-xl font-bold ${pay.color}`}>${pay.amount}</div>
                                        <div className="w-full h-[8px] flex items-end relative">
                                            <div className="absolute bottom-0 left-0 right-0 h-[3px] bg-white/5 rounded-full" />
                                            <div className="flex w-full h-[3px] absolute bottom-0 z-10">
                                                <div className="h-full bg-orange-400 transition-opacity duration-500 rounded-l-full" style={{ width: '33.3%', opacity: countUpTime >= 16*60 ? 1 : 0.1 }} />
                                                <div className="h-full bg-yellow-400 transition-opacity duration-500" style={{ width: '33.3%', opacity: countUpTime >= 38*60 ? 1 : 0.1 }} />
                                                <div className="h-full bg-green-400 transition-opacity duration-500 rounded-r-full" style={{ width: '33.4%', opacity: countUpTime >= 53*60 ? 1 : 0.1 }} />
                                            </div>
                                        </div>
                                    </div>
                                    <div className={panel}>
                                        <span className="text-[14px] opacity-80 font-semibold text-white">Lv Up</span>
                                        <div className={`text-xl font-bold tabular-nums ${getRemainingColor(timeLeft)}`}>
                                            {nextLvl.remaining > 0 ? formatTime(nextLvl.remaining) : "MAX"}
                                        </div>
                                        {nextLvl.remaining > 0 ? <Ruler percent={nextLvl.percent} color="#4ca67c" /> : <div className="h-[8px]" />}
                                    </div>
                                </div>
                            </div>
                            <div className="flex flex-col gap-1.5 w-[42px] items-center justify-center">
                                <button 
                                    onClick={() => { 
                                        if(!isFinished) { 
                                            if(!isActive) {
                                                startTimeRef.current = performance.now();
                                            } else {
                                                accumulatedTimeRef.current += (performance.now() - startTimeRef.current) / 1000;
                                                startTimeRef.current = null;
                                            }
                                            setIsActive(!isActive); 
                                        }
                                    }} 
                                    style={{ backgroundColor: isFinished ? '#333' : isActive ? '#d4b454' : '#4ca67c' }} 
                                    className="w-10 h-10 rounded-full flex items-center justify-center shadow-lg active:scale-95 border border-white/5 transition-colors duration-200 text-white"
                                >
                                    {isActive ? <Icons.Pause size={14} /> : <Icons.Play size={14} className="ml-0.5" />}
                                </button>
                                <button 
                                    onClick={() => { 
                                        setIsActive(false); 
                                        setTimeLeft(INITIAL_SECONDS); 
                                        setIsFinished(false); 
                                        accumulatedTimeRef.current = 0; 
                                        startTimeRef.current = null; 
                                    }} 
                                    className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center active:scale-90 border border-white/5 hover:bg-white/20 transition-colors text-white"
                                >
                                    <Icons.RotateCw size={14} />
                                </button>
                            </div>
                        </div>
                        <div className="px-2 py-1 bg-black/30 text-[9px] opacity-30 flex justify-between border-t border-white/5 uppercase tracking-tighter font-medium">
                            <span>{isFinished ? 'Done' : isActive ? 'Running' : 'Idle'}</span>
                            <span>53M Target</span>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
